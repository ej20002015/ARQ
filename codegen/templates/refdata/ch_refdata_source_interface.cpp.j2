{#
  // codegen-metadata
  // output_path: ARQLib/ARQClickHouse/src/ch_refdata_source_interface.cpp
#}
// THIS FILE IS AUTO-GENERATED BY THE CODE-GEN SCRIPT. DO NOT EDIT.
// Contains the full implementation of the CHRefDataSource class.

#include <ARQClickHouse/ch_refdata_source_interface.h>

#include <ARQUtils/error.h>
#include <ARQUtils/instr.h>
#include <ARQCore/logger.h>

#include "connection.h"

#include <clickhouse/client.h>

namespace ARQ
{

{% for entity in entities %}
// --- Implementation for {{ entity.name }} ---

static std::vector<RDEntities::{{ entity.name }}> internalFetch{{ entity.name_plural }}( const std::string_view dsh, const std::optional<std::string_view> {{ entity.key }} = std::nullopt )
{
    CHConn conn( dsh );

    std::vector<RDEntities::{{ entity.name }}> results;

    Instr::Timer tm;

    static constexpr auto SELECT_STMT = R"(
		SELECT
            {{ entity.key | capitalise_first }},
            {% for member in entity.members %}
            {% if member.name != entity.key %}
            argMax({{ member.name | capitalise_first }}, _LastUpdatedTs) AS max_{{ member.name | capitalise_first }},
            {% endif %}
            {% endfor %}
            argMax(_IsActive, _LastUpdatedTs) AS max_IsActive,
            max(_LastUpdatedTs) AS max_LastUpdatedTs,
            argMax(_LastUpdatedBy, _LastUpdatedTs) AS max_LastUpdatedBy,
            argMax(_Version, _LastUpdatedTs) AS max_Version
		FROM RefData.{{ entity.table_name }}
        {}
        GROUP BY {{ entity.key | capitalise_first }}
		HAVING max_IsActive = 1;
	)";

    std::string whereClause;
    if( {{ entity.key }}.has_value() )
        {% if types[entity.key_type].clickhouse == "String" %}
        whereClause = std::format( "WHERE {{ entity.key | capitalise_first }} = '{}'", {{ entity.key }}.value() );
        {% else %}
        whereClause = std::format( "WHERE {{ entity.key | capitalise_first }} = {}", {{ entity.key }}.value() );
        {% endif %}

    try
    {
        conn.client().Select( std::format( SELECT_STMT, whereClause ), [&] ( const clickhouse::Block& block )
        {
            if( block.GetRowCount() == 0 )
                return; // End of data

            {% for member in entity.members %}
            auto col_{{ member.name }} = block[{{ loop.index0 }}]->As<clickhouse::Column{{ types[member.type].clickhouse}}>();
            {% endfor %}
            auto col_isActive = block[{{ entity.members | length }}]->As<clickhouse::ColumnUInt8>();
            auto col_lastUpdatedTs = block[{{ entity.members | length + 1 }}]->As<clickhouse::ColumnDateTime64>();
            auto col_lastUpdatedBy = block[{{ entity.members | length + 2 }}]->As<clickhouse::ColumnString>();
            auto col_Version = block[{{ entity.members | length + 3 }}]->As<clickhouse::ColumnUInt32>();

            results.reserve( results.size() + block.GetRowCount() );
            for( size_t i = 0; i < block.GetRowCount(); ++i )
            {
                RDEntities::{{ entity.name }} obj;
                {% for member in entity.members %}
                {% if types[member.type].clickhouse == "DateTime64(6)" %}
                obj.{{ member.name }} = Time::DateTime( Time::Microseconds( col_{{ member.name }}->At( i ) ) );
                {% else %}
                obj.{{ member.name }} = col_{{ member.name }}->At( i );
                {% endif %}
                {%- endfor %}
                obj._isActive = col_isActive->At( i );
                obj._lastUpdatedTs = Time::DateTime( Time::Microseconds( col_lastUpdatedTs->At( i ) ) );
                obj._lastUpdatedBy = col_lastUpdatedBy->At( i );
                obj._version = col_Version->At( i );
                results.push_back( std::move( obj ) );
            }
        } );
    }
    catch( const std::exception& e )
    {
        throw ARQException( std::format( "Error executing ClickHouse SELECT query: {}", e.what() ) );
    }

    Log( Module::CLICKHOUSE ).debug( "Ran ClickHouse select query in {}", tm.duration() );

    return results;
}

std::vector<RDEntities::{{ entity.name }}> CHRefDataSource::fetch{{ entity.name_plural }}()
{
    return internalFetch{{ entity.name_plural }}( m_dsh );
}

std::optional<RDEntities::{{ entity.name }}> CHRefDataSource::fetch{{ entity.name }}( const RDEntities::Traits<RDEntities::{{ entity.name }}>::KeyType& {{ entity.key }} )
{
    auto result = internalFetch{{ entity.name_plural }}( m_dsh, {{ entity.key }} );
    return result.empty() ? std::nullopt : std::make_optional( std::move( result.front() ) );
}

// TODO: Need to implement fetchAsOf{{ entity.name_plural }} in a similar manner
// TODO: Need to create some audit load capability

[[nodiscard]] std::vector<RDEntities::{{ entity.name }}> CHRefDataSource::fetchAsOf{{ entity.name_plural }}( const Time::DateTime asof )
{
    return std::vector<RDEntities::{{ entity.name }}>();
}

void CHRefDataSource::upsert{{ entity.name_plural }}( const std::vector<RDEntities::{{ entity.name }}>& data )
{
    CHConn conn( m_dsh );

    Instr::Timer tm;

    try
    {
        {% for member in entity.members %}
        {% if types[member.type].clickhouse == "DateTime64(6)" %}
        auto col_{{ member.name }} = std::make_shared<clickhouse::ColumnDateTime64>( 6 );
        {% else %}
        auto col_{{ member.name }} = std::make_shared<clickhouse::Column{{ types[member.type].clickhouse }}>();
        {% endif %}
        {% endfor %}
        auto col_isActive = std::make_shared<clickhouse::ColumnUInt8>();
        // col_lastUpdatedTs is set to current time in ClickHouse, so we don't need to set it here
        auto col_lastUpdatedBy = std::make_shared<clickhouse::ColumnString>(); // TODO: Maybe set this to the current user?
        auto col_Version = std::make_shared<clickhouse::ColumnUInt32>();

        for( const auto& obj : data )
        {
            {% for member in entity.members %}
            {% if types[member.type].clickhouse == "DateTime64(6)" %}
            col_{{ member.name }}->Append( obj.{{ member.name }}.microsecondsSinceEpoch() );
            {% else %}
            col_{{ member.name }}->Append( obj.{{ member.name }} );
            {% endif %}
            {% endfor %}
            col_isActive->Append( obj._isActive );
            col_lastUpdatedBy->Append( obj._lastUpdatedBy );
            col_Version->Append( obj._version );
        }

        clickhouse::Block block;
        {% for member in entity.members %}
        block.AppendColumn( "{{ member.name | capitalise_first }}", col_{{ member.name }} );
        {% endfor %}
        block.AppendColumn( "_IsActive", col_isActive );
        block.AppendColumn( "_LastUpdatedBy", col_lastUpdatedBy );
        block.AppendColumn( "_Version", col_Version );

        conn.client().Insert( "RefData.{{ entity.table_name }}", block );
    }
    catch( const std::exception& e )
    {
        throw ARQException( std::format( "Error executing ClickHouse INSERT query: {0}", e.what() ) );
    }

    Log( Module::CLICKHOUSE ).debug( "Ran ClickHouse insert query in {}", tm.duration() );
}

{% endfor %}

}