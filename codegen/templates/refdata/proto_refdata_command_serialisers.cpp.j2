{#
  // codegen-metadata
  // output_path: ARQLib/ARQProtobuf/src/proto_refdata_command_serialisers.cpp
#}
// THIS FILE IS AUTO-GENERATED BY THE CODE-GEN SCRIPT. DO NOT EDIT.
// Contains (de)serialisation code for refdata commands

#include "proto_refdata_command_serialisers.h"

#include <ARQUtils/id.h>
#include <ARQProtobuf/rd_entity_proto_converters.h>

#include <proto_gen/refdata_commands.pb.h>

namespace ARQ::Proto::RD::Cmd
{

void registerRefDataCommandSerialisers( Serialiser& serialiser )
{
    {% for entity in entities %}
    serialiser.registerHandler<ARQ::RD::Cmd::Upsert<ARQ::RD::{{ entity.name }}>>( std::make_unique<ProtobufTypeSerialiser_RDCmdUpsert<ARQ::RD::{{ entity.name }}>>() );
	serialiser.registerHandler<ARQ::RD::Cmd::Deactivate<ARQ::RD::{{ entity.name }}>>( std::make_unique<ProtobufTypeSerialiser_RDCmdDeactivate<ARQ::RD::{{ entity.name }}>>() );
    {% endfor %}
}

/*
***************************************************
* Helpers for RefData command proto serialisation *
***************************************************
*/

template<typename ProtoType, typename CmdType>
void setCommonProtoFields( ProtoType& protoObj, const CmdType& cmdObj )
{
	ARQ::Proto::ID::UUID* uuidPtr = protoObj.mutable_target_uuid();
	std::string* uuidBufPtr = uuidPtr->mutable_id();
	*uuidBufPtr = cmdObj.targetUUID.toString();

	std::string* updatedByPtr = protoObj.mutable_updated_by();
	*updatedByPtr = cmdObj.updatedBy;

	protoObj.set_expected_version( cmdObj.expectedVersion );
}

template<typename ProtoType>
Buffer serialiseToBuffer( const ProtoType& protoObj )
{
	Buffer buf( protoObj.ByteSizeLong() );
	protoObj.SerializeToArray( buf.data.get(), buf.size );
	return buf;
}

template<typename ProtoType, typename CmdType>
void setCommonCmdFields( ProtoType& protoObj, CmdType& cmdObj )
{
	cmdObj.targetUUID      = ARQ::ID::UUID::fromString( protoObj.target_uuid().id() );
	cmdObj.updatedBy       = std::move( *protoObj.mutable_updated_by() );
	cmdObj.expectedVersion = protoObj.expected_version();
}

/*
************************************************************
* Protobuf TypeSerialiser definitions for refdata commands *
************************************************************
*/

{% for entity in entities %}
// -------------------- {{ entity.name }} RefData Commands --------------------

template<>
Buffer ProtobufTypeSerialiser_RDCmdUpsert<ARQ::RD::{{ entity.name }}>::serialise( const ARQ::RD::Cmd::Upsert<ARQ::RD::{{ entity.name }}>& obj ) const
{
	Cmd::Upsert{{ entity.name }} protoObj;
	setCommonProtoFields( protoObj, obj );

	{{ entity.name }}* entityPtr = protoObj.mutable_{{ entity.name | snake_case }}();
	toProto( obj.data, entityPtr );

	return serialiseToBuffer( protoObj );
}

template<>
void ProtobufTypeSerialiser_RDCmdUpsert<ARQ::RD::{{ entity.name }}>::deserialise( const BufferView buf, ARQ::RD::Cmd::Upsert<ARQ::RD::{{ entity.name }}>& objOut ) const
{
	Cmd::Upsert{{ entity.name }} protoObj;
	if( !protoObj.ParseFromArray( buf.data, buf.size ) )
		throw ARQException( "Cannot deserialise buffer into RefData Cmd Upsert{{ entity.name }}" );

	setCommonCmdFields( protoObj, objOut );

	objOut.data = fromProto( std::move( *protoObj.mutable_{{ entity.name | snake_case }}() ) );
}

template<>
Buffer ProtobufTypeSerialiser_RDCmdDeactivate<ARQ::RD::{{ entity.name }}>::serialise( const ARQ::RD::Cmd::Deactivate<ARQ::RD::{{ entity.name }}>& obj ) const
{
	Cmd::Deactivate{{ entity.name }} protoObj;
	setCommonProtoFields( protoObj, obj );

	return serialiseToBuffer( protoObj );
}

template<>
void ProtobufTypeSerialiser_RDCmdDeactivate<ARQ::RD::{{ entity.name }}>::deserialise( const BufferView buf, ARQ::RD::Cmd::Deactivate<ARQ::RD::{{ entity.name }}>& objOut ) const
{
	Cmd::Deactivate{{ entity.name }} protoObj;
	if( !protoObj.ParseFromArray( buf.data, buf.size ) )
		throw ARQException( "Cannot deserialise buffer into RefData Cmd Deactivate{{ entity.name }}" );

	setCommonCmdFields( protoObj, objOut );
}

{% endfor %}
}