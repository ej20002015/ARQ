{#
  // codegen-metadata
  // output_path: ARQLib/ARQCore/inc/refdata_repository.h
#}
// THIS FILE IS AUTO-GENERATED BY THE CODE-GEN SCRIPT. DO NOT EDIT.
// Contains the Repository class and its cache for Reference Data entities.

#pragma once
#include <ARQCore/dll.h>

#include <ARQUtils/hashers.h>
#include <ARQCore/refdata_entities.h>
#include <ARQCore/logger.h>
#include <ARQCore/refdata_source.h>

#include <map>
#include <functional>
#include <optional>
#include <mutex>
#include <shared_mutex>

namespace ARQ::RD
{

class Repository;

template<c_RefData T>
class Cache
{
public:
    explicit Cache( const std::map<ID::UUID, T>&& map )
        : m_map( std::move( map ) )
    {}

    [[nodiscard]] std::optional<std::reference_wrapper<const T>> get( const ID::UUID& id ) const
    {
        const auto it = m_map.find( id );
        if( it == m_map.end() )
            return std::nullopt;

        return std::cref( it->second );
    }

private:
    std::map<ID::UUID, T> m_map;

    friend class Repository;
};

class Repository
{
public:
    Repository( const std::string_view dsh )
	    : m_rdSource( RefDataSourceFactory::create( dsh ) )
    {}

    {% for entity in entities %}
    // --- Methods for {{ entity.name }} ({{ entity.type_string }}) ---

    [[nodiscard]] ARQCore_API bool has{{ entity.name_plural }}() const;

    [[nodiscard]] ARQCore_API std::shared_ptr<Cache<{{ entity.name }}>> {{ entity.name_plural }}() const;

    ARQCore_API void reload{{ entity.name_plural }}();

    {% endfor %}
private:
    {% for entity in entities %}
    // --- Methods for {{ entity.name }} ({{ entity.type_string }}) ---
    void loadInitially{{ entity.name_plural }}();

    {% endfor %}
private:
    std::shared_ptr<IRefDataSource> m_rdSource;
    mutable std::shared_mutex m_mut;

    {% for entity in entities %}
    std::shared_ptr<Cache<{{ entity.name }}>> m_{{ entity.name_plural }};
    {% endfor %}
};

}