name: CMake Build & Docker Publish

on:
  push:
    branches: [ "master" ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ "master" ]

jobs:
  # =========================================================
  # JOB 1: BUILD & TEST MATRIX (Windows/Linux)
  # =========================================================
  build:
    name: ${{ matrix.os }} - ${{ matrix.build_type }} - ${{ matrix.c_compiler }}
    runs-on: ${{ matrix.os }}

    env:
      SCCACHE_GHA_ENABLED: "true"

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        build_type: [Release]
        c_compiler: [gcc, clang, cl]
        include:
          - os: windows-latest
            c_compiler: cl
            cpp_compiler: cl
          - os: ubuntu-latest
            c_compiler: gcc
            cpp_compiler: g++
          - os: ubuntu-latest
            c_compiler: clang
            cpp_compiler: clang++
        exclude:
          - os: windows-latest
            c_compiler: gcc
          - os: windows-latest
            c_compiler: clang
          - os: ubuntu-latest
            c_compiler: cl

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set reusable strings
      id: strings
      shell: bash
      run: |
        echo "build-output-dir=${{ github.workspace }}/.build" >> "$GITHUB_OUTPUT"

    # ----------------------------------------------------------------
    # CACHE SETUP
    # ----------------------------------------------------------------
    # Setup sccache for Windows
    - name: Setup sccache (Windows)
      if: matrix.os == 'windows-latest'
      uses: Mozilla-Actions/sccache-action@v0.0.9

    # Setup ccache for Linux
    - name: Setup ccache (Linux)
      if: matrix.os == 'ubuntu-latest'
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ matrix.os }}-${{ matrix.c_compiler }}

    # Configure CMake to USE the cache
    - name: Set Compiler Launcher
      shell: bash
      run: |
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          echo "CMAKE_CXX_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV
        else
          echo "CMAKE_CXX_COMPILER_LAUNCHER=ccache" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=ccache" >> $GITHUB_ENV
        fi

    # ----------------------------------------------------------------
    # LINUX SETUP: Install Ninja, GCC 14 and Clang 18
    # ----------------------------------------------------------------
    - name: Install Dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build
        
        # 1. Install GCC-14
        # We need this REGARDLESS of the compiler. 
        # - If compiling with GCC, we obviously need it.
        # - If compiling with Clang, we need it for the C++23 standard library (libstdc++).
        sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
        sudo apt-get update
        sudo apt-get install -y gcc-14 g++-14

        # 2. Configure Environment for GCC
        if [ "${{ matrix.c_compiler }}" == "gcc" ]; then
          echo "CC=gcc-14" >> $GITHUB_ENV
          echo "CXX=g++-14" >> $GITHUB_ENV
        fi

        # 3. Install & Configure Clang 18
        if [ "${{ matrix.c_compiler }}" == "clang" ]; then
          # Download the official LLVM install script
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          
          # Force the environment to use the new version
          echo "CC=clang-18" >> $GITHUB_ENV
          echo "CXX=clang++-18" >> $GITHUB_ENV
        fi

    # ----------------------------------------------------------------
    # CONFIGURE & BUILD
    # ----------------------------------------------------------------
    - name: Configure CMake (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: >
        cmake -S ${{ github.workspace }}
        -B ${{ steps.strings.outputs.build-output-dir }}
        -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}
        -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}
        -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

    - name: Configure CMake (Linux)
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: >
        cmake -S ${{ github.workspace }}
        -B ${{ steps.strings.outputs.build-output-dir }}
        -G "Ninja Multi-Config"
        -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        # Note: We don't pass CMAKE_CXX_COMPILER here for GCC because 
        # we set CC/CXX env vars in the Install step above to point to gcc-14.
        # For Clang, it defaults to the system clang++ (usually appropriate).

    - name: Build
      run: cmake --build ${{ steps.strings.outputs.build-output-dir }} --config ${{ matrix.build_type }}

    - name: Test
      working-directory: ${{ steps.strings.outputs.build-output-dir }}
      run: ctest --build-config ${{ matrix.build_type }} --output-on-failure -C ${{ matrix.build_type }}

  # =========================================================
  # JOB 2: DOCKER PUBLISH (Only if tests pass)
  # =========================================================
  docker-publish:
    needs: build
    # Don't push Docker images on Pull Requests
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/arq-service
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          # Ensure this path matches where you put your Dockerfile
          file: infra/docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max